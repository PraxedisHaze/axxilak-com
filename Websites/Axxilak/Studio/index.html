<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Axxilak Forge v2.0 | Multi-Template Architecture</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- JSZip for Distribution Bundles -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* Forge UI Styles */
        body {
            background-color: #0f172a;
            color: #f8fafc;
            font-family: 'Inter', sans-serif;
            overflow: hidden;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #1e293b;
        }

        ::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 3px;
        }

        /* Range Slider */
        input[type=range] {
            -webkit-appearance: none;
            background: transparent;
        }

        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 14px;
            width: 14px;
            border-radius: 50%;
            background: #d4af37;
            margin-top: -5px;
        }

        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            background: #334155;
            border-radius: 2px;
        }

        /* Loader */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #d4af37;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite;
            animation: spin 1s linear infinite;
            display: inline-block;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body class="h-screen flex flex-col">

    <!-- HEADER -->
    <header
        class="h-16 bg-slate-900 border-b border-slate-700 flex items-center justify-between px-6 shrink-0 shadow-lg z-20">
        <div class="flex items-center gap-3">
            <div
                class="w-9 h-9 bg-gradient-to-br from-[#d4af37] to-[#8b7355] rounded-lg flex items-center justify-center font-bold text-slate-900 text-lg shadow-glow">
                A</div>
            <div>
                <h1 class="font-bold text-lg tracking-wide leading-none">Axxilak <span
                        class="text-[#d4af37]">Forge</span></h1>
                <span class="text-[10px] text-slate-500 uppercase tracking-widest">System v2.0</span>
            </div>
        </div>

        <div class="flex items-center gap-3">
            <!-- Free Tier - Visible Love -->
            <button onclick="downloadHtmlOnly()"
                class="text-slate-400 hover:text-white px-3 py-2 text-xs font-medium transition-colors flex items-center gap-2 border border-slate-700 rounded hover:border-slate-500">
                <i class="fa-solid fa-code"></i> Download HTML Only (Free)
            </button>

            <!-- Paid Tier - The Product -->
            <button onclick="downloadDistribution()"
                class="bg-[#d4af37] hover:bg-[#b5952f] text-slate-900 font-bold py-2 px-4 rounded text-sm transition-all shadow-lg hover:shadow-[#d4af37]/20 flex items-center gap-2">
                <i class="fa-solid fa-file-zipper"></i> Generate Distribution Kit
            </button>
        </div>
    </header>

    <!-- MAIN WORKSPACE -->
    <main class="flex-1 flex overflow-hidden">

        <!-- LEFT: EDITOR CONTROLS -->
        <aside class="w-80 bg-slate-800 border-r border-slate-700 flex flex-col shrink-0 z-10 shadow-xl">
            <!-- Template Switcher -->
            <div class="p-4 bg-slate-900 border-b border-slate-700">
                <label class="text-[10px] text-slate-400 uppercase font-bold tracking-widest mb-2 block">Active
                    Webling</label>
                <div class="relative">
                    <select id="template-selector" onchange="switchTemplate(this.value)"
                        class="w-full bg-slate-800 text-white text-sm border border-slate-600 rounded p-2 appearance-none focus:border-[#d4af37] outline-none cursor-pointer">
                        <option value="consultant">The Consultant</option>
                        <option value="liquid-gold">Liquid Gold (Premium)</option>
                        <option value="velvet">Velvet (Minimalist)</option>
                    </select>
                    <div class="absolute right-3 top-2.5 text-slate-400 pointer-events-none">
                        <i class="fa-solid fa-chevron-down text-xs"></i>
                    </div>
                </div>
            </div>

            <div class="flex-1 overflow-y-auto p-5 custom-scroll">

                <!-- Dynamic Controls Container -->
                <div id="controls-container" class="space-y-6">
                    <!-- Controls are injected via JS based on state -->
                </div>

                <!-- Hardcoded Logic for Demo -->
                <div class="space-y-6">
                    <div>
                        <h2
                            class="text-xs font-bold text-[#d4af37] uppercase tracking-wider mb-3 flex items-center gap-2">
                            <i class="fa-solid fa-palette"></i> Design System
                        </h2>
                        <div class="space-y-3">
                            <div>
                                <label class="text-xs text-slate-300 block mb-1">Primary Color</label>
                                <div class="flex gap-2">
                                    <input type="color" id="ctrl-primary"
                                        class="w-8 h-8 rounded cursor-pointer border-none bg-transparent p-0"
                                        oninput="updateState('colors.primary', this.value)">
                                    <input type="text" id="txt-primary"
                                        class="flex-1 bg-slate-700 border border-slate-600 rounded text-xs px-2 text-slate-300 font-mono"
                                        readonly>
                                </div>
                            </div>
                            <div>
                                <label class="text-xs text-slate-300 block mb-1">Background</label>
                                <div class="flex gap-2">
                                    <input type="color" id="ctrl-bg"
                                        class="w-8 h-8 rounded cursor-pointer border-none bg-transparent p-0"
                                        oninput="updateState('colors.background', this.value)">
                                    <input type="text" id="txt-bg"
                                        class="flex-1 bg-slate-700 border border-slate-600 rounded text-xs px-2 text-slate-300 font-mono"
                                        readonly>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h2
                            class="text-xs font-bold text-[#d4af37] uppercase tracking-wider mb-3 flex items-center gap-2">
                            <i class="fa-solid fa-pen-nib"></i> Identity
                        </h2>
                        <div class="space-y-3">
                            <div>
                                <label class="text-xs text-slate-300 block mb-1">Name</label>
                                <input type="text" id="ctrl-name"
                                    class="w-full bg-slate-700 border border-slate-600 rounded p-2 text-sm text-white focus:border-[#d4af37] outline-none transition-colors"
                                    oninput="updateState('text.name', this.value)">
                            </div>
                            <div>
                                <label class="text-xs text-slate-300 block mb-1">Role / Tagline</label>
                                <input type="text" id="ctrl-tagline"
                                    class="w-full bg-slate-700 border border-slate-600 rounded p-2 text-sm text-white focus:border-[#d4af37] outline-none transition-colors"
                                    oninput="updateState('text.tagline', this.value)">
                            </div>
                            <div>
                                <label class="text-xs text-slate-300 block mb-1">Bio</label>
                                <textarea id="ctrl-bio" rows="3"
                                    class="w-full bg-slate-700 border border-slate-600 rounded p-2 text-sm text-white focus:border-[#d4af37] outline-none transition-colors"
                                    oninput="updateState('text.bio', this.value)"></textarea>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h2
                            class="text-xs font-bold text-[#d4af37] uppercase tracking-wider mb-3 flex items-center gap-2">
                            <i class="fa-regular fa-image"></i> Assets
                        </h2>
                        <div class="relative group">
                            <input type="file" id="ctrl-img-upload" accept="image/*" class="hidden"
                                onchange="handleSmartImageUpload(this)">
                            <label for="ctrl-img-upload"
                                class="flex flex-col items-center justify-center w-full h-24 border-2 border-dashed border-slate-600 rounded-lg cursor-pointer hover:border-[#d4af37] hover:bg-slate-700/50 transition-all">
                                <i
                                    class="fa-solid fa-cloud-arrow-up text-slate-400 mb-1 text-xl group-hover:text-[#d4af37] transition-colors"></i>
                                <span class="text-xs text-slate-400 group-hover:text-slate-200">Upload Profile
                                    Photo</span>
                            </label>
                            <div id="compression-indicator"
                                class="hidden absolute inset-0 bg-slate-900/80 flex items-center justify-center rounded-lg">
                                <div class="loader"></div>
                            </div>
                        </div>
                        <p class="text-[10px] text-slate-500 mt-2 flex items-center gap-1">
                            <i class="fa-solid fa-bolt text-yellow-500"></i> Auto-compressed to < 150KB </p>
                    </div>
                </div>
            </div>

            <!-- Live Stats -->
            <div
                class="mt-auto p-3 border-t border-slate-700 bg-slate-950 flex justify-between items-center text-[10px] text-slate-500 font-mono">
                <span>STATE SIZE: <span id="state-size" class="text-green-400">0 KB</span></span>
                <span><i class="fa-solid fa-circle text-green-500 text-[6px] mr-1"></i>AUTO-SAVED</span>
            </div>
        </aside>

        <!-- CENTER: PREVIEW CANVAS -->
        <div class="flex-1 bg-[#050505] flex flex-col relative bg-dots">
            <!-- Preview Toolbar -->
            <div
                class="h-12 bg-slate-800/80 backdrop-blur border-b border-slate-700 flex items-center justify-center gap-6 px-4">
                <div class="flex bg-slate-700 rounded p-1">
                    <button onclick="setPreviewMode('desktop')" id="btn-desktop"
                        class="px-3 py-1 rounded text-slate-300 hover:text-white hover:bg-slate-600 transition-all text-xs active-mode"><i
                            class="fa-solid fa-desktop mr-1"></i> Desktop</button>
                    <button onclick="setPreviewMode('mobile')" id="btn-mobile"
                        class="px-3 py-1 rounded text-slate-300 hover:text-white hover:bg-slate-600 transition-all text-xs"><i
                            class="fa-solid fa-mobile-screen mr-1"></i> Mobile</button>
                </div>

                <div class="w-px h-4 bg-slate-600"></div>

                <button onclick="resetTemplate()"
                    class="text-xs text-red-400 hover:text-red-300 flex items-center gap-1">
                    <i class="fa-solid fa-rotate-left"></i> Reset
                </button>
            </div>

            <!-- Iframe Wrapper -->
            <div class="flex-1 flex items-center justify-center p-4 overflow-hidden">
                <div id="preview-wrapper"
                    class="w-full h-full bg-white shadow-2xl transition-all duration-500 ease-in-out relative ring-1 ring-slate-800">
                    <iframe id="preview-frame" class="w-full h-full border-none"
                        sandbox="allow-scripts allow-same-origin"></iframe>
                </div>
            </div>
        </div>
    </main>

    <!-- === TEMPLATE LIBRARY (Hidden) === -->

    <!-- 1. THE CONSULTANT (Standard) -->
    <script type="text/template" id="tpl-consultant">
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <style>
                :root { --primary: {{colors.primary}}; --bg: {{colors.background}}; --text: {{colors.text}}; }
                body { background: var(--bg); color: var(--text); font-family: 'Helvetica Neue', sans-serif; margin: 0; line-height: 1.6; }
                .container { max-width: 900px; margin: 0 auto; padding: 0 20px; }
                header { padding: 2rem 0; display: flex; justify-content: space-between; align-items: center; }
                .logo { font-weight: 900; letter-spacing: -1px; font-size: 1.5rem; }
                .hero { padding: 4rem 0; display: flex; align-items: center; gap: 4rem; }
                .hero-content { flex: 1; }
                h1 { font-size: 3rem; line-height: 1.1; margin-bottom: 1rem; }
                .tagline { color: var(--primary); font-weight: bold; text-transform: uppercase; letter-spacing: 2px; font-size: 0.8rem; }
                .btn { background: var(--primary); color: var(--bg); padding: 10px 20px; text-decoration: none; font-weight: bold; display: inline-block; margin-top: 1rem; }
                .img-box { width: 300px; height: 350px; background: #333; position: relative; }
                .img-box img { width: 100%; height: 100%; object-fit: cover; position: absolute; top: 10px; right: 10px; box-shadow: -20px 20px 0 var(--primary); }

                /* Contact Section Upgrade */
                .contact-form { margin-top: 4rem; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 4rem; }
                input, textarea { width: 100%; padding: 10px; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: inherit; margin-bottom: 10px; }
                textarea { resize: vertical; min-height: 100px; }

                @media(max-width: 768px) { .hero { flex-direction: column; } .img-box { width: 100%; } }
            </style>
        </head>
        <body>
            <div class="container">
                <header>
                    <div class="logo">{{text.name}}</div>
                    <a href="#contact" class="btn">Contact</a>
                </header>
                <section class="hero">
                    <div class="hero-content">
                        <div class="tagline">{{text.tagline}}</div>
                        <h1>{{text.bio_short}}</h1>
                        <p>{{text.bio}}</p>
                    </div>
                    <div class="img-box"><img src="{{images.profile}}"></div>
                </section>
                <section class="contact-form" id="contact">
                    <h3>Send a Message</h3>
                    <form>
                        <input type="text" placeholder="Name">
                        <input type="email" placeholder="Email">
                        <!-- MANDATORY MESSAGE FIELD -->
                        <textarea placeholder="Tell us what you're thinking..."></textarea>
                        <button class="btn">Send Message</button>
                    </form>
                </section>
            </div>
        </body>
        </html>
    </script>

    <!-- 2. LIQUID GOLD (Premium/Dark) -->
    <script type="text/template" id="tpl-liquid-gold">
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <style>
                :root { --gold: {{colors.primary}}; --dark: #050505; --light: #f1f1f1; }
                body { background: var(--dark); color: var(--light); font-family: 'Garamond', serif; margin: 0; }
                .border-gold { border: 1px solid var(--gold); }
                .text-gold { color: var(--gold); }
                .container { max-width: 800px; margin: 0 auto; padding: 40px 20px; text-align: center; }
                h1 { font-size: 4rem; font-weight: 100; letter-spacing: 0.1em; margin: 0.5em 0; text-transform: uppercase; }
                .profile-img { width: 150px; height: 150px; border-radius: 50%; border: 2px solid var(--gold); object-fit: cover; margin: 0 auto; display: block; }
                .bio { font-size: 1.2rem; line-height: 1.8; color: #888; margin: 2rem 0; font-family: sans-serif; }
                .cta-btn { background: transparent; border: 1px solid var(--gold); color: var(--gold); padding: 15px 30px; letter-spacing: 2px; text-decoration: none; text-transform: uppercase; transition: 0.3s; display: inline-block; }
                .cta-btn:hover { background: var(--gold); color: var(--dark); }

                /* Message Area */
                .contact-area { margin-top: 60px; text-align: left; border-top: 1px solid #222; padding-top: 40px; }
                label { display: block; color: var(--gold); font-size: 0.7rem; letter-spacing: 2px; text-transform: uppercase; margin-bottom: 5px; }
                input, textarea { width: 100%; background: #111; border: none; border-bottom: 1px solid #333; padding: 10px; color: white; margin-bottom: 20px; transition: border 0.3s; font-family: sans-serif; }
                input:focus, textarea:focus { border-bottom-color: var(--gold); outline: none; }
            </style>
        </head>
        <body>
            <div class="container">
                <img src="{{images.profile}}" class="profile-img">
                <p style="margin-top: 20px; letter-spacing: 3px; color: var(--gold); text-transform: uppercase; font-size: 0.8rem;">{{text.tagline}}</p>
                <h1>{{text.name}}</h1>
                <p class="bio">{{text.bio}}</p>
                <a href="#contact" class="cta-btn">{{text.cta}}</a>

                <div class="contact-area" id="contact">
                    <label>Inquiry</label>
                    <input type="text" placeholder="Your Name">
                    <label>Details</label>
                    <textarea placeholder="How can we collaborate?"></textarea>
                    <button class="cta-btn" style="width: 100%; cursor: pointer;">Submit</button>
                </div>
            </div>
        </body>
        </html>
    </script>

    <!-- 3. VELVET (Minimalist) -->
    <script type="text/template" id="tpl-velvet">
        <!DOCTYPE html>
        <html lang="en">
        <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <style>
                :root { --accent: {{colors.primary}}; --bg: #fff; --text: #222; }
                /* Dark Mode Support via State */
                @media (prefers-color-scheme: dark) { :root { --bg: {{colors.background}}; --text: {{colors.text}}; } }

                body { background: var(--bg); color: var(--text); font-family: 'Arial', sans-serif; margin: 0; padding: 40px; }
                .layout { display: grid; grid-template-columns: 1fr 2fr; gap: 60px; max-width: 1000px; margin: 0 auto; height: calc(100vh - 80px); align-items: center; }
                h1 { font-size: 5rem; line-height: 0.9; margin: 0; letter-spacing: -2px; }
                .accent { color: var(--accent); }
                .meta { font-family: monospace; font-size: 0.9rem; margin-top: 20px; border-left: 2px solid var(--accent); padding-left: 15px; }
                .image-pane { height: 100%; background: #f0f0f0; border-radius: 20px; overflow: hidden; }
                .image-pane img { width: 100%; height: 100%; object-fit: cover; }

                /* Message Box */
                .input-group { margin-top: 30px; }
                textarea { width: 100%; border: 2px solid #eee; padding: 15px; border-radius: 10px; margin-top: 10px; font-family: inherit; }
                textarea:focus { border-color: var(--accent); outline: none; }

                @media(max-width: 768px) { .layout { grid-template-columns: 1fr; height: auto; } h1 { font-size: 3rem; } .image-pane { height: 400px; } }
            </style>
        </head>
        <body>
            <div class="layout">
                <div class="content">
                    <h1>{{text.name}}<span class="accent">.</span></h1>
                    <div class="meta">
                        <p>{{text.tagline}}</p>
                        <p>{{text.bio}}</p>
                    </div>
                    <div class="input-group">
                        <small style="text-transform: uppercase; letter-spacing: 1px; font-weight: bold;">Send Message</small>
                        <textarea placeholder="Type here..."></textarea>
                    </div>
                </div>
                <div class="image-pane">
                    <img src="{{images.profile}}">
                </div>
            </div>
        </body>
        </html>
    </script>

    <!-- Editor Source (For Distribution) -->
    <script type="text/template" id="tpl-editor-source">
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Axxilak Standalone Editor</title>
    <style>
        body { margin: 0; font-family: sans-serif; display: flex; height: 100vh; overflow: hidden; background: #1a1a1a; color: white; }
        #sidebar { width: 300px; background: #222; padding: 20px; border-right: 1px solid #333; overflow-y: auto; }
        .control { margin-bottom: 15px; }
        label { display: block; font-size: 10px; uppercase; color: #888; margin-bottom: 5px; }
        input, textarea { width: 100%; background: #333; border: 1px solid #444; color: white; padding: 8px; box-sizing: border-box; }
        iframe { flex: 1; border: none; background: white; }
        .btn { width: 100%; padding: 10px; background: #d4af37; border: none; font-weight: bold; cursor: pointer; margin-top: 20px; }
    </style>
</head>
<body>
    <div id="sidebar">
        <h3>Editor</h3>
        <div id="controls"></div>
        <button class="btn" onclick="exportSite()">EXPORT HTML</button>
    </div>
    <iframe id="preview"></iframe>
    <script>
        // INJECTED DATA
        const state = __STATE_PLACEHOLDER__;
        const template = `__TEMPLATE_PLACEHOLDER__`;

        // RUNTIME
        const frame = document.getElementById('preview');
        const controls = document.getElementById('controls');

        function render() {
            let html = template;
            // Simple replacement engine
            html = html.replace(/{{text.name}}/g, state.text.name);
            html = html.replace(/{{text.tagline}}/g, state.text.tagline);
            html = html.replace(/{{text.bio}}/g, state.text.bio);
            html = html.replace(/{{text.bio_short}}/g, state.text.bio.substring(0,50));
            html = html.replace(/{{text.cta}}/g, state.text.cta);
            html = html.replace(/{{colors.primary}}/g, state.colors.primary);
            html = html.replace(/{{colors.background}}/g, state.colors.background);
            html = html.replace(/{{colors.text}}/g, state.colors.text);
            html = html.replace(/{{images.profile}}/g, state.images.profile);

            const doc = frame.contentDocument;
            doc.open(); doc.write(html); doc.close();
        }

        function createControl(label, key, type='text') {
            const div = document.createElement('div');
            div.className = 'control';
            div.innerHTML = `<label>${label}</label>`;
            const inp = document.createElement(type === 'textarea' ? 'textarea' : 'input');
            if(type === 'color') inp.type = 'color';

            // Resolve nested key
            const keys = key.split('.');
            inp.value = state[keys[0]][keys[1]];

            inp.oninput = (e) => {
                state[keys[0]][keys[1]] = e.target.value;
                render();
            };
            div.appendChild(inp);
            controls.appendChild(div);
        }

        // Init
        createControl('Primary Color', 'colors.primary', 'color');
        createControl('Background', 'colors.background', 'color');
        createControl('Name', 'text.name');
        createControl('Tagline', 'text.tagline');
        createControl('Bio', 'text.bio', 'textarea');

        render();

        function exportSite() {
            const doc = frame.contentDocument;
            const blob = new Blob([doc.documentElement.outerHTML], {type: 'text/html'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = 'index.html';
            a.click();
        }
    <\/script>
</body>
</html>
    </script>

    <script>
        // --- MASTER LOGIC ---

        const defaults = {
            colors: { primary: "#d4af37", background: "#0a0a0a", text: "#f5f5f5" },
            text: {
                name: "Alex Vayner",
                tagline: "Strategic Consultant",
                bio: "Helping businesses navigate complexity through data-driven strategies.",
                bio_short: "Strategy Meets Design",
                cta: "Work With Me"
            },
            images: { profile: "https://via.placeholder.com/400x400/333/d4af37?text=Profile" },
            activeTemplate: "consultant"
        };

        let currentState = JSON.parse(JSON.stringify(defaults));

        // Smart Image Compression Engine
        async function handleSmartImageUpload(input) {
            if (input.files && input.files[0]) {
                const file = input.files[0];
                document.getElementById('compression-indicator').classList.remove('hidden');

                const compressedBase64 = await compressImage(file);

                currentState.images.profile = compressedBase64;
                document.getElementById('compression-indicator').classList.add('hidden');
                updateStateSize();
                renderPreview();
            }
        }

        function compressImage(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (event) => {
                    const img = new Image();
                    img.src = event.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const ctx = canvas.getContext('2d');

                        // Resize logic (Max 800px)
                        const MAX_WIDTH = 800;
                        const MAX_HEIGHT = 800;
                        let width = img.width;
                        let height = img.height;

                        if (width > height) {
                            if (width > MAX_WIDTH) { height *= MAX_WIDTH / width; width = MAX_WIDTH; }
                        } else {
                            if (height > MAX_HEIGHT) { width *= MAX_HEIGHT / height; height = MAX_HEIGHT; }
                        }

                        canvas.width = width;
                        canvas.height = height;
                        ctx.drawImage(img, 0, 0, width, height);

                        // Compression (0.7 quality)
                        resolve(canvas.toDataURL('image/jpeg', 0.7));
                    };
                };
            });
        }

        function switchTemplate(tplName) {
            currentState.activeTemplate = tplName;

            // Adjust defaults for themes
            if (tplName === 'velvet') {
                currentState.colors.primary = "#ff3366";
                currentState.colors.background = "#ffffff";
            } else if (tplName === 'liquid-gold') {
                currentState.colors.primary = "#d4af37";
                currentState.colors.background = "#050505";
            } else {
                currentState.colors.primary = "#d4af37";
                currentState.colors.background = "#0a0a0a";
            }

            syncInputs();
            renderPreview();
        }

        function renderPreview() {
            let tpl = document.getElementById(`tpl-${currentState.activeTemplate}`).innerHTML;

            // Regex Replacement
            for (const [section, data] of Object.entries(currentState)) {
                if (typeof data === 'object') {
                    for (const [key, val] of Object.entries(data)) {
                        const regex = new RegExp(`{{${section}.${key}}}`, 'g');
                        tpl = tpl.replace(regex, val);
                    }
                }
            }

            // Computed props
            tpl = tpl.replace(/{{text.bio_short}}/g, currentState.text.bio.substring(0, 50));

            const frame = document.getElementById('preview-frame');
            const doc = frame.contentDocument || frame.contentWindow.document;
            doc.open(); doc.write(tpl); doc.close();

            updateStateSize();
        }

        function updateState(path, value) {
            const [sec, key] = path.split('.');
            currentState[sec][key] = value;
            if (sec === 'colors') {
                document.getElementById(key === 'primary' ? 'txt-primary' : 'txt-bg').value = value;
            }
            renderPreview();
        }

        function syncInputs() {
            document.getElementById('ctrl-primary').value = currentState.colors.primary;
            document.getElementById('txt-primary').value = currentState.colors.primary;
            document.getElementById('ctrl-bg').value = currentState.colors.background;
            document.getElementById('txt-bg').value = currentState.colors.background;
            document.getElementById('ctrl-name').value = currentState.text.name;
            document.getElementById('ctrl-tagline').value = currentState.text.tagline;
            document.getElementById('ctrl-bio').value = currentState.text.bio;
        }

        function updateStateSize() {
            const json = JSON.stringify(currentState);
            const size = new Blob([json]).size;
            document.getElementById('state-size').innerText = (size / 1024).toFixed(1) + " KB";
        }

        function setPreviewMode(mode) {
            const wrapper = document.getElementById('preview-wrapper');
            const deskBtn = document.getElementById('btn-desktop');
            const mobileBtn = document.getElementById('btn-mobile');

            if (mode === 'mobile') {
                wrapper.style.maxWidth = '375px';
                wrapper.style.height = '80%';
                wrapper.style.borderRadius = '20px';
                wrapper.style.border = '8px solid #333';
                deskBtn.classList.remove('active-mode', 'text-white');
                mobileBtn.classList.add('active-mode', 'text-white');
            } else {
                wrapper.style.maxWidth = '100%';
                wrapper.style.height = '100%';
                wrapper.style.borderRadius = '0';
                wrapper.style.border = 'none';
                mobileBtn.classList.remove('active-mode', 'text-white');
                deskBtn.classList.add('active-mode', 'text-white');
            }
        }

        function resetTemplate() {
            if (confirm("Reset everything?")) {
                location.reload();
            }
        }

        // --- EXPORT LOGIC ---
        function downloadHtmlOnly() {
            const doc = document.getElementById('preview-frame').contentDocument;
            const blob = new Blob([doc.documentElement.outerHTML], { type: "text/html" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `${currentState.text.name.replace(/\s+/g, '_')}_webling.html`;
            link.click();
        }

        async function downloadDistribution() {
            const zip = new JSZip();

            // Get Current Template Source
            const rawTemplate = document.getElementById(`tpl-${currentState.activeTemplate}`).innerHTML;
            let editorCode = document.getElementById('tpl-editor-source').innerHTML;

            // Inject State & Template into Editor
            const stateStr = JSON.stringify(currentState);
            editorCode = editorCode.replace('__STATE_PLACEHOLDER__', stateStr);
            const cleanTpl = rawTemplate.replace(/`/g, '\\`').replace(/\${/g, '\\${');
            editorCode = editorCode.replace('__TEMPLATE_PLACEHOLDER__', cleanTpl);

            zip.file("editor.html", editorCode);
            zip.file("index.html", rawTemplate);
            zip.file("README.md", `# Your Webling\n\nDouble click editor.html to edit.`);

            const content = await zip.generateAsync({ type: "blob" });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(content);
            link.download = "Axxilak_Bundle.zip";
            link.click();
        }

        // Init
        const bgDotStyle = document.createElement('style');
        bgDotStyle.innerHTML = `.bg-dots { background-image: radial-gradient(#334155 1px, transparent 1px); background-size: 20px 20px; } .active-mode { background: #475569; color: white !important; }`;
        document.head.appendChild(bgDotStyle);

        syncInputs();
        renderPreview();

    </script>
</body>

</html>
